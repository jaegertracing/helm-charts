name: Lint and Test Charts

on: pull_request

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - uses: azure/setup-helm@v4
        with:
          version: v3.14.4

      # Python is required because `ct lint` runs Yamale (https://github.com/23andMe/Yamale) and
      # yamllint (https://github.com/adrienverge/yamllint) which require Python
      - uses: actions/setup-python@v6
        with:
          python-version: '3.14'

      - uses: helm/chart-testing-action@v2.8.0
        with:
          version: v3.10.1

      - run: make lint

  test-with-all-in-one:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - uses: ./.github/actions/prepare-k8s

      - run: make test

  test-with-elasticsearch:
      runs-on: ubuntu-latest
      steps:
        - uses: actions/checkout@v6
          with:
            fetch-depth: 0

        - uses: ./.github/actions/prepare-k8s

        - run: make test-es
